---
title: "einsum!ã‚’ä½œã‚‹"
emoji: "ğŸ“"
type: "tech"
topics: ["rust", "ndarray", "einsum"]
published: true
---

[å‰å›ã®è¨˜äº‹](./numpy-einsum)ã§ã¯æ—¢å­˜å®Ÿè£…ã¨ã—ã¦NumPyã«ãŠã‘ã‚‹`numpy.einsum`ã®ä»•æ§˜ã‚’è¦‹ã¦ã„ãã¾ã—ãŸãŒã€ä»Šå›ã¯Rustã®[ndarray crate](https://crates.io/crates/ndarray)å‘ã‘ã«einsumã‚’ä½œã£ã¦ã„ãã¾ã™ã€‚å®Œæˆå½¢ã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼š

```rust
use ndarray::array;
use einsum_derive::einsum;

let a = array![
  [1.0, 2.0],
  [3.0, 4.0]
];
let b = array![
  [1.0, 2.0],
  [3.0, 4.0]
];
let c = einsum!("ij,jk->ik", a, b);
assert_eq!(c, array![
  [6.0, 8.0],
  [12.0, 16.0]
]);
```

ã“ã®[`einsum_derive` crate](https://crates.io/crates/einsum-derive)ã¯ä¸‹è¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã§é–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ï¼š
https://github.com/termoshtt/einsum-derive

ãªãŠç¾åœ¨ã®å®Ÿè£…ã§ã¯å‰å›èª¬æ˜ã—ãŸçœç•¥è¨˜å·`...`ã‚’å«ã‚€einsumã¯ã‚µãƒãƒ¼ãƒˆå‡ºæ¥ã¦ã„ã¾ã›ã‚“ã€‚ã¾ãŸBLASæ¼”ç®—ã«ç½®ãæ›ãˆã‚‹æ“ä½œã‚‚ã¾ã å®Ÿè£…ã•ã‚Œã¦ãŠã‚‰ãšã€ç´ æœ´ãªãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚‹å®Ÿè£…ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™ã€‚

å…¨ä½“åƒã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

```mermaid
flowchart TB
  Input["einsum!(ij,jk->ik, a, b)"]-- "ij,jk->ik" -->Parser
  subgraph codegen["einsum_codgen crate"]
    Parser["Parse subscripts"]-- "Subscripts" -->Factorize
    Factorize["Factorize subscripts"]-- "Path" -->Codegen
  end
  Codegen["Code generation"]-->Output
  Input-- "a, b" -->Output[Generated Rust code]
```

einsumå…¥é–€
-----------
å®Ÿè£…ã®è§£èª¬ã‚’å§‹ã‚ã‚‹å‰ã«einsumã®æ©Ÿèƒ½ã«ã¤ã„ã¦å°‘ã—è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ç†è«–ç‰©ç†ç­‰ã®æ–‡è„ˆã«ç½®ã„ã¦ã€ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³ã®ç¸®ç´„è¨˜æ³•ã¨ã„ã†ã®ã¯è¤‡æ•°ã®ãƒ†ãƒ³ã‚½ãƒ«ã‚’å–ã‚‹æ¼”ç®—ã§å’Œã®è¨˜å·$\sum$ã‚’çœç•¥ã€ã‚ã‚‹ã„ã¯é€†ã«è£œå®Œã™ã‚‹ãƒ«ãƒ¼ãƒ«ã§ã™ã€‚ä¾‹ãˆã°$N$æ¬¡å…ƒãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ç©ºé–“ã®äºŒã¤ã®ãƒ™ã‚¯ãƒˆãƒ«$x, y \in \mathbb{R}^N$ã®å†…ç©

$$
(x, y) = \sum_{i=1}^N x_i y_i
$$

ã‚’å’Œã®è¨˜å·ã‚’çœç•¥ã—ã¦$x_i y_i$ã®æ§˜ã«è¡¨è¨˜ã—ã¾ã™ã€‚é€†ã«äºŒã¤ã®ãƒ™ã‚¯ãƒˆãƒ«$x, y \in \mathbb{R}^N$ãŒä¸ãˆã‚‰ã‚ŒãŸã¨ãã€$x_i y_i$ã¨æ›¸ã„ãŸã‚‰ä¸Šã®å’Œã‚’è€ƒãˆã‚‹äº‹ã«ã—ã¾ã™ã€‚æ·»å­—ã«å¯¾ã™ã‚‹å’Œã¯å¸¸ã«å–ã‚Šã†ã‚‹å…¨ã¦ã®å€¤ã«ã¤ã„ã¦å–ã‚‹äº‹ã«ã—ã¦ã€ä¾‹ãˆã°æœ€åˆã®äºŒã¤ã ã‘å’Œã‚’å–ã‚‹ $x_1 y_1 + x_2 y_2$ã®æ§˜ãªå‡¦ç†ã¯è€ƒãˆãªã„äº‹ã«ã—ã¾ã™ã€‚ä»–ã«ã‚‚3ã¤ã®$N \times N$è¡Œåˆ—$A, B, C \in M_N(\mathbb{R})$ã®ç©

$$
(ABC)_{il} = \sum_{j, k} A_{ij}B_{jk}C_{kl}
$$

ã‚’å˜ã«$A_{ij}B_{jk}C_{kl}$ã®æ§˜ã«è¡¨è¨˜ã—ã¾ã™ã€‚è¤‡æ•°å›ç¾ã‚Œã‚‹æ·»å­—ã«ã¤ã„ã¦ã®ã¿å’Œã‚’å–ã‚‹ã“ã¨ã«ã—ã€ä¸€å›ã ã‘ç¾ã‚Œã‚‹æ·»å­—ã«ã¤ã„ã¦ã¯å’Œã‚’å–ã‚‰ãªã„äº‹ã«ã—ã¾ã™ã€‚

ä¸Šè¨˜ã®æ§˜ãªä»£è¡¨çš„ãªæ¼”ç®—ã«ä»˜ã„ã¦ã¯ç·šå½¢ä»£æ•°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå´ã«ã‚‚å¯¾å¿œã—ãŸé–¢æ•°ãŒç”¨æ„ã•ã‚Œã¾ã™ãŒã€ã“ã®ã‚ˆã†ã«è¤‡æ•°ã®ãƒ†ãƒ³ã‚½ãƒ«ã‚’å—ã‘å–ã£ã¦ã‚ã‚‹æ·»å­—ã«å¯¾ã—ã¦å’Œã‚’å–ã‚‹é–¢æ•°ã¯éå¸¸ã«ãŸãã•ã‚“å­˜åœ¨ã—ã¾ã™ã€‚ã§ã¯ã“ã‚Œã‚‰ã®é–¢æ•°ã¯è‡ªå‹•çš„ã«ä½œã‚Œãªã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿãã“ã§ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³ã®ç¸®ç´„è¨˜æ³•ã«ãŠã‘ã‚‹å’Œã®è£œå®Œè¦å‰‡ã®æ–¹ã«ç€ç›®ã—ã¾ã™ã€‚ã¤ã¾ã‚Š$x_i y_i$ã¨æ›¸ãã¨äºŒã¤ã®ãƒ™ã‚¯ãƒˆãƒ«ã«å¯¾ã—ã¦å†…ç©ã‚’è¨ˆç®—ã™ã‚‹æ¼”ç®—ã‚’è¡¨ã™ã‚ã‘ã§ã™ãŒã€ã“ã‚Œã‚’ã•ã‚‰ã«çµ„$(x, y)$ã‹ã‚‰$x_i y_i$ã«ä¸ãˆã‚‹é–¢æ•°

$$
\mathbb{R}^N \times \mathbb{R}^N \ni (x, y) \longmapsto x_i y_i \in \mathbb{R}
$$

ã ã¨æ€ã£ã¦ã€ã“ã®é–¢æ•°ã‚’`i,i->`ã¨æ›¸ãã“ã¨ã«ã—ã¾ã™ã€‚æ·»å­—ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆä¸€æ–‡å­—ã§ã‚ã‚Œã°ä½•ã§ã‚‚ã‚ˆãã€`i,i->`ã¨`j,j->`ã¯åŒã˜é–¢æ•°ã‚’è¡¨ã™ã“ã¨ã«ã—ã¾ã™ã€‚åŒã˜ã‚ˆã†ã«3ã¤ã®è¡Œåˆ—ã‚’å¼•æ•°ã«è¡Œåˆ—-è¡Œåˆ—-è¡Œåˆ—ç©ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°

$$
M_N(\mathbb{R}) \times M_N(\mathbb{R}) \times M_N(\mathbb{R}) \ni (A, B, C) \longmapsto A_{ij}B_{jk}C_{kl} \in M_N(\mathbb{R})
$$

ã‚’`ij,jk,kl->il`ã¨æ›¸ãã¾ã™ã€‚ã“ã®ã‚ˆã†ã«ç¸®ç´„è¨˜æ³•ã§ã‹ã‘ã‚‹æ“ä½œã‚’ã€ãã®æ·»å­—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã§æ–‡å­—åˆ—ã¨ã—ã¦é–¢æ•°ã‚’æŒ‡å®šã™ã‚‹äº‹ãŒã§ãã¾ã™ã€‚ã“ã®æ–‡å­—åˆ—ã‚’è§£é‡ˆã—ã¦è¿½åŠ ã®å¼•æ•°ã¨ã—ã¦ã‚‚ã‚‰ã£ãŸãƒ†ãƒ³ã‚½ãƒ«ã«å¯¾ã—ã¦å®Ÿè¡Œã™ã‚‹å‡¦ç†ç³»ã®äº‹ã‚’einsumã¨å‘¼ã³ã¾ã™ã€‚

æ‰‹ç¶šããƒã‚¯ãƒ­ã«ã‚ˆã‚‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
-----------------------------
Rustã«ã¯æ¨™æº–ã§æ‰‹ç¶šããƒã‚¯ãƒ­(procedural macro, proc-macroã¨ã‚ˆãå‘¼ã°ã‚Œã‚‹)ã¨å‘¼ã°ã‚Œã‚‹ã€Rustã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’Rustã§è¨˜è¿°ã§ãã‚‹æ©Ÿèƒ½ãŒå­˜åœ¨ã—ã¾ã™ã€‚ä¸Šã®ä¾‹ã§è¨€ãˆã° `einsum!("ij,jk->ik", a, b)`ã®éƒ¨åˆ†ãŒæ‰‹ç¶šããƒã‚¯ãƒ­ã®å‘¼ã³å‡ºã—ã«å¯¾å¿œã—ã¦ã„ã¦ã€ã“ã‚Œã«ã‚ˆã‚Š`"ij,jk->ik", a, b`ã‚’å…¥åŠ›ãŒRustã®ã‚³ãƒ¼ãƒ‰ã®æ§‹æ–‡æœ¨(ã¨ã„ã†ã‹ãƒˆãƒ¼ã‚¯ãƒ³åˆ—)ã‚’å‡ºåŠ›ã¨ã™ã‚‹é–¢æ•°

```rust
#[proc_macro]
pub fn einsum(input: TokenStream) -> TokenStream { ... }
```

ã«æ¸¡ã•ã‚Œã¦å®Ÿè¡Œã•ã‚Œã€ã“ã®å®Ÿè¡Œçµæœã®ãƒˆãƒ¼ã‚¯ãƒ³åˆ—

```rust
{
    fn ij_jk__ik<T, S0, S1>(
        arg0: ndarray::ArrayBase<S0, ndarray::Ix2>,
        arg1: ndarray::ArrayBase<S1, ndarray::Ix2>,
    ) -> ndarray::Array<T, ndarray::Ix2>
    where
        T: ndarray::LinalgScalar,
        S0: ndarray::Data<Elem = T>,
        S1: ndarray::Data<Elem = T>,
    {
        let (n_i, n_j) = arg0.dim();
        let (_, n_k) = arg1.dim();
        {
            let (n_0, n_1) = arg0.dim();
            assert_eq!(n_0, n_i);
            assert_eq!(n_1, n_j);
        }
        {
            let (n_0, n_1) = arg1.dim();
            assert_eq!(n_0, n_j);
            assert_eq!(n_1, n_k);
        }
        let mut out0 = ndarray::Array::zeros((n_i, n_k));
        for i in 0..n_i {
            for k in 0..n_k {
                for j in 0..n_j {
                    out0[(i, k)] = arg0[(i, j)] * arg1[(j, k)];
                }
            }
        }
        out0
    }
    let arg0 = a;
    let arg1 = b;
    let out0 = ij_jk__ik(arg0, arg1);
    out0
}
```

ãŒ`einsum!`ã®å‘¼ã³å‡ºã—éƒ¨åˆ†ã«ç½®æ›ã•ã‚Œã¦æœ¬æ¥ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒè¡Œã‚ã‚Œã¾ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã“ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒè¡Œã‚ã‚Œã¦ã„ã‚‹äº‹ã«å…¨ãæ°—ã¥ã‹ãªã„ã¾ã¾ã€ç‰¹åˆ¥ãªã‚³ãƒ¼ãƒ‰ç”Ÿæˆã®ç‚ºã®è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ç„¡ãã€é€šå¸¸ã®`println!`ç­‰ã®ãƒã‚¯ãƒ­ã®æ§˜ã«ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

ä»Šå›ã¯æ‰‹ç¶šããƒã‚¯ãƒ­ã‚’ç”¨ã„ã¦einsumã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã€å®Ÿè¡Œæ™‚ã®æƒ…å ±ã§ã‚ã‚‹ãƒ†ãƒ³ã‚½ãƒ«ã®å½¢çŠ¶ã¨strideã®æƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã›ã‚“ã€‚å¯èƒ½ã§ã‚ã‚Œã°ãƒ†ãƒ³ã‚½ãƒ«ã®å½¢çŠ¶ã¨strideã®æƒ…å ±ã‚’æŒã£ãŸä¸Šã§è¨ˆç®—ã™ã‚‹é †åºã‚’æ±ºå®šã™ã‚‹æ–¹ãŒæœ‰åˆ©ã«ãªã‚Šå¾—ã¾ã™ãŒã€ã“ã®è¨­è¨ˆã§ã¯å…¨ã¦ã®ã‚µã‚¤ã‚ºãŒåŒä¸€ã§ã‚ã‚‹ã¨ä»®å®šã—ã¦ãã®æœ€é©åŒ–ã¯åˆã‚ã‹ã‚‰è«¦ã‚ã¾ã™ã€‚

Subscriptã®ãƒ‘ãƒ¼ã‚¹
-----------------
TODO: nomã‚’ä½¿ã£ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã‚ˆ(Â´ãƒ»Ï‰ãƒ»ï½€)

einsumã®åˆ†è§£
-------------
ä¾‹ãˆã°3ã¤ã®$N \times N$è¡Œåˆ—$A, B, C$ã®ç©$ABC$ã‚’è€ƒãˆã¾ã—ã‚‡ã†

$$
(ABC)_{il} = \sum_{j, k} A_{ij} B_{jk} C_{kl}
$$

ã“ã®å‡¦ç†ã¯einsumã®è¨˜æ³•ã§ã„ã†ã¨`ij,jk,kl->il`ã¨æ›¸ã‘ã¾ã™ã€‚ã“ã‚Œã¯ç´ æœ´ã«è¨ˆç®—ã™ã‚‹ã¨ã€å„æ·»å­—$(i, l)$ã«å¯¾ã—ã¦å³è¾ºã¯$N^2$å€‹ã®é …ã®å’Œã«ãªã‚‹ã®ã§å…¨ä½“ã§è¨ˆç®—é‡ã¯$O(N^4)$å¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä¸€æ–¹ã‚ˆãçŸ¥ã‚‰ã‚Œã¦ã„ã‚‹æ§˜ã«è¡Œåˆ—ã®ç©ã¯çµåˆçš„ãªã®ã§ã€ä¸€æ—¦$A$ã¨$B$ã®ç©ã‚’å…ˆã«è¨ˆç®—ã—ã¦ã—ã¾ã£ã¦æ¬¡ã«$(AB)C$ã‚’è¨ˆç®—ã—ã¦ã‚‚åŒã˜çµæœã«ãªã‚Šã¾ã™ã€‚ãã“ã§ä¸Šã®å‡¦ç†ã‚’

$$
\begin{align*}
  (AB)_{ik}  &= \sum_{j} A_{ij} B_{jk} \\
  (ABC)_{il} &= \sum_{k} (AB)_{ik} C_{kl}
\end{align*}
$$

ã®æ§˜ã«åˆ†ã‘ã¦ä¸­é–“ã®è¡Œåˆ—$AB$ã‚’ãƒ¡ãƒ¢ãƒªã«ä¿æŒã™ã‚‹äº‹ã«ã™ã‚‹ã¨ã€ãã‚Œãã‚Œã®è¨ˆç®—é‡ã¯å„$(i,k)$ã«å¯¾ã—ã¦$N$å€‹ã®å’Œã‚’å–ã‚‹ã“ã¨ã«ãªã‚‹ã®ã§$O(N^3)$ã¨ãªã‚Šã€ãã‚Œãã‚Œã‚’ä¸€å›ãšã¤ã‚„ã‚Œã°ã„ã„ã®ã§å…¨ä½“ã§ã‚‚$O(N^3)$ã¨ãªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Š$O(N^4)$ã®è¨ˆç®—ãŒå¿…è¦ã ã£ãŸã‚‚ã®ã‚’$O(N^2)$å€‹ã®ä¸­é–“å€¤ã‚’ãƒ¡ãƒ¢ã™ã‚‹äº‹ã§$O(N^3)$ã®è¨ˆç®—é‡ã«è½ã¨ã™äº‹ãŒå‡ºæ¥ã¾ã—ãŸã€‚

### ãƒ†ãƒ³ã‚½ãƒ«ã®åå‰ç®¡ç†
ã“ã‚Œã‚’einsumã®è¨˜æ³•ã§æ›¸ãã¨ã©ã†ãªã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿç›´æ„Ÿçš„ã«ã¯`ij,jk,kl->il`ã‚’`ij,jk->ik`ã¨`ik,kl->il`ã«åˆ†è§£ã—ãŸã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€ã“ã‚Œã ã¨ä¸€ã¤ç›®ã®`ik`ã¨äºŒã¤ç›®ã®`ik`ãŒå¯¾å¿œã—ã¦ã„ã‚‹äº‹ãŒä¸Šæ‰‹ãè¡¨ã›ã¦ã„ã¾ã›ã‚“ã€‚ãã“ã§å…ƒã®æ•°å¼ã®é€šã‚Šã€ã“ã“ã«ã©ã®ãƒ†ãƒ³ã‚½ãƒ«ã‚’ä½¿ã†ã®ã‹ã‚’è¿½åŠ ã—ãŸè¨˜æ³•ã‚’ç”¨æ„ã—ã¾ã—ã‚‡ã†ã€‚ã¾ãšåˆ†è§£å‰ã®einsumã‚’

```
ij,jk,kl->il | arg0,arg1,arg2->out0
```

ã®ã‚ˆã†ã«`|`ã§åŒºåˆ‡ã£ãŸå³å´ã«ãƒ†ãƒ³ã‚½ãƒ«ã®åå‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚å¼•æ•°ã¨ã—ã¦å–ã‚‹ãƒ†ãƒ³ã‚½ãƒ«ã¯ãã®é †ç•ªã«å¿œã˜ã¦`arg{N}`ã€einsumãŒç”Ÿæˆã™ã‚‹ãƒ†ãƒ³ã‚½ãƒ«ã¯`out{N}`ã®ã‚ˆã†ã«åå‰ã‚’ä»˜ã‘ã¾ã™ã€‚ã“ã®è¡¨è¨˜ã‚’ä½¿ã†ã¨ä¸Šè¨˜ã®åˆ†è§£ã¯æ¬¡ã®æ§˜ã«æ›¸ã‘ã¾ã™

```
ij,jk->ik | arg0,arg1->out1
ik,kl->il | out1,arg2->out0
```

å‡¦ç†ã¯ä¸Šã‹ã‚‰é †ç•ªã«å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚ã“ã‚Œã§é€”ä¸­ã§ç”Ÿæˆã•ã‚Œã‚‹$AB$ã«å¯¾å¿œã™ã‚‹ãƒ†ãƒ³ã‚½ãƒ«å€¤ã®åå‰ã¯`out1`ã§ã‚ã‚Šã€ãã‚ŒãŒä¸€ã¤ç›®ã®einsumã§ç”Ÿæˆã•ã‚ŒãŸå‡ºåŠ›ã§ã‚ã£ã¦ã€äºŒã¤ç›®ã®å‡¦ç†ã§ç¬¬ä¸€å¼•æ•°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚ã“ã®æ§˜ã«ãƒ†ãƒ³ã‚½ãƒ«ã«åå‰ã‚’ã¤ã‘ãŸçŠ¶æ…‹ã§ä¸¦ã¹ãŸã‚‚ã®ã‚’ãƒ‘ã‚¹ã¨å‘¼ã¶ã“ã¨ã«ã—ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ä¸Šã§ã¯ [einsum_codgen::Path](https://docs.rs/einsum-codegen/latest/einsum_codegen/struct.Path.html)ãŒå¯¾å¿œã—ã¾ã™ã€‚

ã“ã®è¡¨è¨˜æ³•ã¯å˜ã«ç§ã®å¥½ã¿ã§ã€ã“ã†ã§ã‚ã‚‹å¿…è¦ã¯ç„¡ã„ã§ã™ã€‚ä¾‹ãˆã°å…ƒã®æ•°å¼ã«è¿‘ã¥ã‘ã¦
```
arg0 @ ij, arg1 @ jk, arg2 @ kl -> out0 @ il
```
ã®æ§˜ã«æ›¸ãã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚é‡è¦ãªã®ã¯åˆ†è§£ã‚’è¨˜è¿°ã™ã‚‹ã«ã¯ãƒ†ãƒ³ã‚½ãƒ«ã«ãƒ‘ã‚¹ã®ä¸­ã§æœ‰åŠ¹ãªåå‰ã‚’ã¤ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã¨ã„ã†ç‚¹ã§ã™ã€‚

### åˆ†è§£é †åºã¨è¨ˆç®—é‡
ã“ã®åˆ†è§£ã¯ã„ã¤å¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿè¡Œåˆ—ç©ã®å ´åˆã¯è‡ªæ˜ã«åˆ†è§£å‡ºãã‚‹ã“ã¨ãŒåˆ†ã‹ã‚Šã¾ã—ãŸãŒã€ä¸€èˆ¬ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ã«åˆ†è§£ã™ã‚‹ã‹ã‚’ã©ã†æ±ºã‚ã‚Œã°ã„ã„ã®ã§ã—ã‚‡ã†ï¼Ÿ
ã“ã®å•é¡Œã‚’è€ƒãˆã‚‹ãŸã‚ã€ä¸Šã®ä¾‹ã‚’å°‘ã—æ›¸ãæ›ãˆã¦ã¿ã¾ã—ã‚‡ã†ï¼š

$$
(ABC)_{il} = \sum_{j, k} A_{ij} B_{jk} C_{kl} = \sum_{k} C_{kl} \sum_j A_{ij} B_{jk}
$$

ä¸€ã¤ã®$\sum$ã‚’äºŒã¤ã®$\sum$ã«åˆ†ã‘ã‚‹éš›ã«ã€å†…å´ã¨å¤–å´ã®ãƒ†ãƒ³ã‚½ãƒ«ã®çµ„($\{ A, B \}$ ã¨ $\{ C \}$)ã¨æ·»å­—ã®çµ„($\{ j\}$ã¨$\{k\}$)ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹äº‹ãŒåˆ†ã‹ã‚Šã¾ã™ã€‚å†…å´ã¨å¤–å´ã®ãƒ†ãƒ³ã‚½ãƒ«ã¨æ·»å­—ã®çµ„ã®ã„ãšã‚Œã‚‚ç©ºã«ãªã‚‰ãªã„å ´åˆã‚’åˆ†è§£å¯èƒ½ã‚ã‚‹ã„ã¯å¯ç´„ã€å‡ºæ¥ãªã„å ´åˆã‚’æ—¢ç´„ã¨å‘¼ã¶äº‹ã«ã—ã¾ã—ã‚‡ã†ã€‚ã“ã®åˆ†è§£ã¯ä¾‹ãˆã°ä¸Šã®ä¾‹ã§ã¯$(AB)C$ã¨$A(BC)$ã®åˆ†è§£ãŒå¯èƒ½ãªäº‹ã‹ã‚‰åˆ†ã‹ã‚‹ã‚ˆã†ã«ä¸€æ„ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ã“ã®åˆ†è§£ã¯å†å¸°çš„ã«è¡Œã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ä¾‹ãˆã°è¡Œåˆ—-è¡Œåˆ—-ãƒ™ã‚¯ãƒˆãƒ«ç©$ABCv$ã‚’è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã“ã‚Œã¯`ij,jk,kl,l->i`ã¨æ›¸ã‘ã¾ã™ãŒã€ã¾ãšæœ€å¾Œã®è¡Œåˆ—-ãƒ™ã‚¯ãƒˆãƒ«ç©ã‚’è¡Œã†ã“ã¨ã§

```
kl,l->k    | arg2,arg3->out1
ij,jk,k->i | arg0,arg1,out1->out0
```

ã¨ãªã‚Šã¾ã™ã€‚ã•ã‚‰ã«äºŒã¤ç›®ã®einsumã‚’åŒã˜ã‚ˆã†ã«æœ€å¾Œã®è¡Œåˆ—-ãƒ™ã‚¯ãƒˆãƒ«ç©ã‚’é¸ã‚“ã§åˆ†è§£ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Š

```
kl,l->k | arg2,arg3->out1
jk,k->j | arg1,out1->out2
ij,j->i | arg0,out2->out0
```

ã®ã‚ˆã†ã«è¡Œåˆ—-è¡Œåˆ—ç©ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ãªã„3æ®µã®è¡Œåˆ—-ãƒ™ã‚¯ãƒˆãƒ«ç©ã®å½¢ã«åˆ†è§£ã•ã‚Œã€è¨ˆç®—é‡ã¯$O(N^2)$ã§æ¸ˆã¿ã¾ã™ã€‚ä¸€æ–¹ã§æœ€åˆã«å…ˆé ­ã®è¡Œåˆ—-è¡Œåˆ—ç©ã‚’é¸ã‚“ã§ã—ã¾ã†ã¨

```
ij,jk->ik  | arg0,arg1->out1
ik,kl,l->i | out1,arg2,arg3->out0
```

å†ã³å…ˆé ­ã®è¡Œåˆ—-è¡Œåˆ—ç©ã‚’é¸ã¶ã¨

```
ij,jk->ik | arg0,arg1->out1
ik,kl->il | out1,arg2->out2
il,l->i   | out2,arg3->out0
```

ã®ã‚ˆã†ã«åˆ†è§£ã•ã‚Œã€ã“ã‚Œä»¥ä¸Šåˆ†è§£ã§ãã¾ã›ã‚“ã€‚ã“ã®å½¢ã§ã¯è¨ˆç®—é‡ã¯$O(N^3)$ã‹ã‹ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ã«åˆ†è§£ã®æ–¹æ³•ã«ã‚ˆã£ã¦å¿…è¦ãªè¨ˆç®—é‡ãŒå¤‰åŒ–ã—ã¾ã™ã€‚

ç¾åœ¨ã®å®Ÿè£…(0.1.0)ã§ã¯å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†è§£ã«å¯¾ã—ã¦è¨ˆç®—é‡ã¨ãƒ¡ãƒ¢ãƒªã®ã‚ªãƒ¼ãƒ€ãƒ¼ã‚’è¨ˆç®—ã—ã€æœ€å°ã®`Path`ã‚’è¨ˆç®—ã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
-----------
æœ€å¾Œã«æ±‚ã¾ã£ãŸ`Path`ã‹ã‚‰Rustã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ä¸Šè¿°ã—ãŸæ§˜ã«einsumã®subscriptã¯é–¢æ•°ã‚’è¡¨ã™ã®ã§ã€ä¾‹ãˆã°`ij,jk->ik`ã¯äºŒã¤ã®2æ¬¡å…ƒé…åˆ—ã‚’å—ã‘å–ã‚Š2æ¬¡å…ƒé…åˆ—ã‚’è¿”ã™é–¢æ•°ã«å±•é–‹ã•ã‚Œã¾ã™ã€‚Rustã®é–¢æ•°ã®è­˜åˆ¥å­ã¨ã—ã¦`,`ã‚„`->`ã¯ä½¿ãˆãªã„ã®ã§ã€ã“ã®éƒ¨åˆ†ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦é–¢æ•°åã«ã—ã¾ã™

```rust
fn ij_jk__ik<T, S0, S1>(
    arg0: ndarray::ArrayBase<S0, ndarray::Ix2>,
    arg1: ndarray::ArrayBase<S1, ndarray::Ix2>,
) -> ndarray::Array<T, ndarray::Ix2>
where
    T: ndarray::LinalgScalar,
    S0: ndarray::Data<Elem = T>,
    S1: ndarray::Data<Elem = T>,
{ ... }
```

ã“ã®é–¢æ•°ã¯`einsum!`ãƒã‚¯ãƒ­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã¯ç›´æ¥è¦‹ãˆã¦ã»ã—ããªã„ã®ã§ã€ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä½œã£ã¦ãã®ä¸­ã§å®šç¾©ã—ã¾ã™ã€‚ã¤ã¾ã‚Š

```rust
let c = einsum!("ij,jk->ik", a, b);
```

ã‚’æ¬¡ã®æ§˜ã«å±•é–‹ã—ã¾ã™ï¼š

```rust
let c = {
    // å¿…è¦ãªé–¢æ•°ã‚’å®šç¾©ã™ã‚‹
    // ã“ã®é–¢æ•°ã¯ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—ã®å¤–ã‹ã‚‰ã¯è¦‹ãˆãªã„
    fn ij_jk__ik<T, S0, S1>(
        arg0: ndarray::ArrayBase<S0, ndarray::Ix2>,
        arg1: ndarray::ArrayBase<S1, ndarray::Ix2>,
    ) -> ndarray::Array<T, ndarray::Ix2>
    where
        T: ndarray::LinalgScalar,
        S0: ndarray::Data<Elem = T>,
        S1: ndarray::Data<Elem = T>,
    { ... }

    // ãƒã‚¯ãƒ­ã®å¼•æ•°ã®åå‰ã‚’æ•´ç†
    let arg0 = a;
    let arg1 = b;

    // â†‘ã§ä½œã£ãŸé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    let out0 = ij_jk__ik(arg0, arg1);

    // ãƒ–ãƒ­ãƒƒã‚¯ã‹ã‚‰å€¤ã‚’è¿”ã™
    out0
};
```

è¤‡æ•°ã®einsumã«åˆ†è§£ã•ã‚Œã¦ã„ã‚‹ã¨ãã¯å¯¾å¿œã™ã‚‹é–¢æ•°ã‚’ã¾ãšå®šç¾©ã—ã¦ã€ä¸Šã§è­°è«–ã—ãŸãƒ†ãƒ³ã‚½ãƒ«ã®åå‰ã‚’é ¼ã‚Šã«é †ç•ªã«ãã‚Œã‚‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ãã¾ã™ã€‚

---
title: "numpy.einsumã®ä»•æ§˜"
emoji: "ðŸŽ“"
type: "tech"
topics: ["numpy", "python", "einsum"]
published: true
---

[rust-ndarray](https://github.com/rust-ndarray/ndarray)ç”¨ã® `einsum!` ãƒžã‚¯ãƒ­ã‚’ä½œã‚‹ãŸã‚ã«ã¾ãš[NumPy][einsum]ã®å®Ÿè£…ã‚’èª¿ã¹ãŸã®ã§ã€ãã®å†…å®¹ã‚’ã¾ã¨ã‚ã¦ã„ãã€‚

[einsum]: https://numpy.org/doc/stable/reference/generated/numpy.einsum.html

subscripts
-----------

[numpy.einsum][einsum]ã®å¼•æ•°ã¯ã®ã†ã¡ã€Optionalã§ç„¡ã„ã®ã¯æ¬¡ã®äºŒã¤ï¼š

- `subscripts`: str
- `operands`: list of array_like

`einsum` ã¯ã“ã® `subscripts` ã§ä¸Žãˆã‚‰ã‚ŒãŸæ–‡å­—åˆ—ã«å¿œã˜ã¦ `operands` ã§ä¸Žãˆã‚‰ã‚ŒãŸãƒ†ãƒ³ã‚½ãƒ«ã«å¯¾ã—ã¦æ“ä½œã‚’è¡Œã„ãã®çµæžœã‚’è¿”ã™ã€‚ä¾‹ãˆã°äºŒã¤ã®æ­£æ–¹è¡Œåˆ—ã®ç©ã¯æ¬¡ã®æ§˜ã«æ›¸ã‘ã‚‹ï¼š

```python
import numpy as np
a = np.random.random((3, 3))
b = np.random.random((3, 3))
np.einsum("ij,jk", a, b)
```

ã“ã®è¨˜äº‹ã§ã¯ `subscripts` ã®ä»•æ§˜ã‚’ã¾ã¨ã‚ã‚‹ã®ãŒç›®çš„ã¨ãªã‚‹ã€‚

Implicit mode
--------------
`subscripts` ã«ã¯implicit modeã¨explicit modeãŒå­˜åœ¨ã—ã€implicit modeã«ãŠã„ã¦ã¯ `subscripts` ã¯ `,` ã§åŒºåˆ‡ã‚‰ã‚ŒãŸå¼•æ•°ã®æ·»å­—ã‹ã‚‰ãªã‚‹ã€‚EBNF-likeã«æ›¸ãã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚‹ï¼š

```text
index = `a` | `b` | `c` | `d` | `e` | `f` | `g` | `h` | `i` | `j` | `k` | `l` | `m` | `n`
      | `o` | `p` | `q` | `r` | `s` | `t` | `u` | `v` | `w` | `x` | `y` | `z`;
subscript = { index] };
implicit_subscripts = subscript {`,` [subscript] }
```

ä¾‹ãˆã° `ij,jk` ã®ã‚ˆã†ãªæ–‡å­—åˆ—ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã®è©•ä¾¡è¦å‰‡ã¯æ¬¡ã®é€šã‚Šã§ã™ï¼š

- åŒã˜æ·»å­—ãŒ2å›žä»¥ä¸Šç¾ã‚ŒãŸã‚‰ã€ãã®æ·»å­—ã«ã¤ã„ã¦ã¯å’Œã‚’ã¨ã‚‹
- æ®‹ã£ãŸæ·»å­—ãŒã‚ã‚‹å ´åˆã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ä¸¦ã¹ãŸæ·»å­—ã«åŸºã¥ã„ã¦ `ndarray` ã‚’å‡ºåŠ›ã¨ã—ã€æ·»å­—ãŒç„¡ã‘ã‚Œã°ã‚¹ã‚«ãƒ©ãƒ¼å€¤ã‚’å‡ºåŠ›ã¨ã™ã‚‹
- å€‹ã€…ã® `subscript` ã¨ `operands` ã®æ¬¡å…ƒãŒé•ã†å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹

`ij,jk` ã«å¯¾ã—ã¦ã¯ã¾ãš `j` ãŒ2å›žç¾ã‚Œã‚‹ã®ã§å’Œã‚’ã¨ã‚Šã€çµæžœã¯ `i` ã¨ `k` ã‚’ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ä¸¦ã¹ãŸ `ik` ã®æ·»å­—ã‹ã‚‰ãªã‚‹ `ndarray` ã‚’è¿”ã—ã¾ã™ã€‚æ·»å­—ã¯ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã‚‹ã®ã§ã€ä¾‹ãˆã° `np.einsum("ij", a)` ã¯ãã®ã¾ã¾ `a` ãŒè¿”ã•ã‚Œã¾ã™ãŒã€`np.einsum("ji", a)` ã¯è»¢ç½®ã‚’ã¨ã‚Šã¾ã™ã€‚

Explicit mode
--------------
Expicit modeã«ãŠã„ã¦ã¯ `subscripts` ã¯implicit modeã®å ´åˆã® `,` ã§åŒºåˆ‡ã‚‰ã‚ŒãŸå¼•æ•°ã®æ·»å­—ã«ç¶šã„ã¦ `->` ãŒç½®ã‹ã‚Œãã®å¾Œã«å‡ºåŠ›ã®æ·»å­—ãŒç½®ã‹ã‚Œã‚‹ã€‚EBNF-likeã«æ›¸ãã¨æ¬¡ã®æ§˜ã«ãªã‚‹ï¼š

```text
index = `a` | `b` | `c` | `d` | `e` | `f` | `g` | `h` | `i` | `j` | `k` | `l` | `m` | `n`
      | `o` | `p` | `q` | `r` | `s` | `t` | `u` | `v` | `w` | `x` | `y` | `z`;
subscript = { index] };
explicit_subscripts = subscript{`,` [subscript] } `->` [subscript]
```

ä¾‹ãˆã° `ij,jk->ik` ã®æ§˜ãªæ–‡å­—åˆ—ã«ãªã‚‹ã€‚ã“ã®è©•ä¾¡è¦å‰‡ã¯implicit modeã®å ´åˆã«æ¯”ã¹ã¦å°‘ã—è¤‡é›‘ã«ãªã£ã¦

- å‡ºåŠ›ã«ç¾ã‚ŒãŸæ·»å­—ã«ã¤ã„ã¦ã¯å’Œã‚’ã¨ã‚‰ãªã„
- å‡ºåŠ›ã«å«ã¾ã‚Œãªã„ã€å¼•æ•°ã«è¤‡æ•°å›žå‡ºç¾ã™ã‚‹æ·»å­—ã«ã¤ã„ã¦ã¯å’Œã‚’ã¨ã‚‹
- å‡ºåŠ›ã®æ·»å­—ã«åŸºã¥ã„ã¦æ·»å­—ãŒç©ºã§ç„¡ã„ã¨ãã¯ `ndarray` ã‚’ã€ç©ºã®æ™‚ã¯ã‚¹ã‚«ãƒ©ãƒ¼å€¤ã‚’è¿”ã™

ã“ã‚Œã«ã‚ˆã£ã¦è¡Œåˆ—ã®å¯¾è§’æˆåˆ†ã‚’ãƒ™ã‚¯ãƒˆãƒ«ã¨ã—ã¦æŠœãå‡ºã™æ“ä½œã‚’ `ii->i` ã®ã‚ˆã†ã«è¨˜è¿°ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸå‡ºåŠ›ã®æ·»å­—ã‚’æ˜Žç¤ºçš„ã«æ›¸ãã®ã§implicit modeã®æ™‚ã®ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆã™ã‚‹è¦å‰‡ã¯ã“ã®å ´åˆã‚ã‚Šã¾ã›ã‚“ã€‚

çœç•¥è¨˜å· `...`
---------------
æ·»å­—ã®éƒ¨åˆ†ã«çœç•¥è¨˜å· `...` ã‚’ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚ä¾‹ãˆã° `np.einsum('...ii->...i', a)`

---
title: "Pythonã®Build Backend"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "pyo3", "maturin", "uv"]
published: false
---

Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã¯C++ã‚„Rustã§å®Ÿè£…ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ä»•çµ„ã¿ã‚’å‚™ãˆã¦ã„ã¾ã™ãŒã€å°‘ã—è¤‡é›‘ãªãŸã‚ã€å•é¡ŒãŒèµ·ããŸéš›ã«ä½•ãŒå¤±æ•—ã—ã¦ã„ã‚‹ã®ã‹ã‚’æŠŠæ¡ã—ã¥ã‚‰ã„ã‚±ãƒ¼ã‚¹ãŒå¤šã„ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ **ç¾åœ¨ã®ä»•æ§˜ã«æ²¿ã£ã¦** Pythonã®ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã®ä»•çµ„ã¿ã‚’è§£èª¬ã—ã¾ã™ã€‚

:::message
Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã¯æ”¹è‰¯ãŒé€²ã‚€ã“ã¨ã§è¡¨é¢çš„ãªä»•æ§˜ãŒå¤‰åŒ–ã—ã€ä¸€æ–¹å··ã«ã¯å¤ã„æƒ…å ±ãŒæ®‹ã£ã¦ã„ã‚‹ã®ã§æ··ä¹±ã—ãŒã¡ã§ã™ã€‚ã“ã®è¨˜äº‹ã§ã¯ãã®æ ¹æœ¬ã®ä»•çµ„ã¿ã‚’è§£èª¬ã™ã‚‹ã“ã¨ã§ã€å¤ã„æƒ…å ±ã«æƒ‘ã‚ã•ã‚Œãšã«å•é¡Œè§£æ±ºã«å–ã‚Šçµ„ã‚€ãŸã‚ã®åŸºç¤çŸ¥è­˜ã‚’æä¾›ã—ã¾ã™ã€‚
:::

ã“ã®è¨˜äº‹ã¯ä¸»ã«æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã„ã¾ã™:

https://packaging.python.org/ja/latest/overview/

## ãƒ“ãƒ«ãƒ‰é…å¸ƒç‰©ï¼ˆWheelï¼‰ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é…å¸ƒç‰©ï¼ˆsdistï¼‰

ãã‚Œãã‚Œã®ãƒ„ãƒ¼ãƒ«ã®å½¹å‰²ã‚’è­°è«–ã™ã‚‹ã«ã¯ã¾ãšãã‚Œã‚‰ã®å…¥å‡ºåŠ›ã‚’ç¢ºèªã™ã‚‹ã®ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚Pythonã®ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã¯ä¸»ã«æ¬¡ã®äºŒã¤ã®é…å¸ƒç‰©ã‚’æ‰±ã„ã¾ã™:
- ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é…å¸ƒç‰©ï¼ˆsdistï¼‰: ã“ã‚Œã¯ã•ã‚‰ã«äºŒã¤ã®ç”¨é€”ãŒã‚ã‚Šã¾ã™ã€‚
  - Pythonã®ã¿ã§è¨˜è¿°ã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãã®ã¾ã¾é…å¸ƒã™ã‚‹ã®ã§ã€ãƒ“ãƒ«ãƒ‰ã¯å¿…è¦ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å˜ã«ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’é©åˆ‡ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã§ `tar.gz` ã«å›ºã‚ãŸã‚‚ã®ã§ã™ã€‚
  - C++ã‚„Rustã§è¨˜è¿°ã•ã‚ŒãŸPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ç’°å¢ƒã§ãƒ“ãƒ«ãƒ‰ã—ã¦ä½¿ã„ãŸã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã‚‚ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é…å¸ƒç‰©ã¨ã—ã¦é…å¸ƒã—ã¾ã™ã€‚ã“ã‚Œã¯ãã®ã¾ã¾ã§ã¯ä½¿ãˆãªã„ã®ã§ã€å–å¾—ã—ãŸã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãŒãƒ“ãƒ«ãƒ‰ã‚’è¡Œã„ã¾ã™ã€‚
- ãƒ“ãƒ«ãƒ‰é…å¸ƒç‰©ï¼ˆWheelï¼‰
  - Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã§ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é…å¸ƒç‰©ã‚’ãƒ“ãƒ«ãƒ‰ã•ã›ã‚‹ã®ã§ã¯ãªãã€äºˆã‚ãƒ“ãƒ«ãƒ‰ã—ãŸæˆæœç‰©ã‚’é…å¸ƒã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã«ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒãªãã€ã¾ãŸãƒ“ãƒ«ãƒ‰ã«ã¯å¤šãã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã™ã‚‹ãŸã‚ã€ãƒ“ãƒ«ãƒ‰æ¸ˆã¿ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é…å¸ƒãŒä¸€èˆ¬çš„ã§ã™ã€‚ãŸã ã—ãƒ“ãƒ«ãƒ‰ã®æˆæœç‰©ã¯OSã‚„Pythonã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ä¾å­˜ã™ã‚‹ã®ã§ã€ã‚ˆãã‚ã‚‹ç’°å¢ƒå‘ã‘ã«è¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## Build Frontendã¨Backend

Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ãƒ“ãƒ«ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰é…å¸ƒç‰©ãŒé…å¸ƒã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã¯ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã—ã‹ã—ã“ã®ä¸–ã®å…¨ã¦ã‚’ãƒ“ãƒ«ãƒ‰å‡ºæ¥ã‚‹ãƒ„ãƒ¼ãƒ«ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã«çµ„ã¿è¾¼ã‚€ã‚ã‘ã«ã¯ã„ã‹ãªã„ã®ã§ã€å€‹ã€…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å´ãŒä½•ã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã®ã‹ã‚’æŒ‡å®šã—ã¾ã™ã€‚ã“ã®æ™‚ã«æŒ‡å®šã•ã‚Œã‚‹ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã®äº‹ã‚’Build Backendã¨å‘¼ã³ã¾ã™ã€‚

ä¾‹ãˆã°Rustè£½ã®Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯å…¸å‹çš„ã«ã¯æ¬¡ã®ã‚ˆã†ã« `pyproject.toml` ã«è¨˜è¿°ã—ã¾ã™:

```toml:pyproject.toml
[build-system]
requires = ["maturin >= 1.8.2"]  # ãƒ“ãƒ«ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•ã™ã‚‹ã®ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¨˜è¿°
build-backend = "maturin"        # èµ·å‹•ã™ã‚‹Pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æŒ‡å®š
```

`requires` ã§æŒ‡å®šã•ã‚Œã‚‹ `maturin` ã¯[Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦ã® `maturin`](https://pypi.org/project/maturin/) ã§ã‚ã‚Šã€`build-backend` ã§æŒ‡å®šã•ã‚ŒãŸ `maturin` ã¯Pythonã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®äº‹ã§

```shell
python -m ${build-backend ã§æŒ‡å®šã•ã‚ŒãŸãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å}
```

ã¨åŒã˜æŒ™å‹•ã«ãªã‚‹ã¯ãšã§ã™ã€‚

é€†ã«å„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã‚’å§”ä»»ã™ã‚‹å´ã‚’Build Frontendã¨å‘¼ã³ã€ã“ã‚Œã¯å…¸å‹çš„ã«ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã€ä¾‹ãˆã° `pip` ã‚„ `uv` ã§ã™ã€‚

ã‚„ã‚„ã“ã—ã„ã“ã¨ã«ã€Build Backendã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã«ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã—ã¦ã®æ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹ã‚‚ã®ã‚‚ã‚ã‚Šã¾ã™ã€‚ä¾‹ãˆã° `maturin` ã¯CLIãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã ã‘ã§ç„¡ãã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚‚è¡Œãˆã¾ã™ã€‚ãªã®ã§ã€Œ`maturin` ã¯Build Backendãƒ„ãƒ¼ãƒ«ã€ã§ã¯ãªãã€Œ`maturin`ã¯Build Backendã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã™ã‚‹ã€ã¨ç†è§£ã™ã‚‹ã®ãŒé©åˆ‡ã§ã™ã€‚

## Case Study

ã•ã¦åŸºç¤äº‹é …ã‚’ç†è§£ã—ãŸã¨ã“ã‚ã§ã€æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦ã®åˆ†é¡ã‚’ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### build (`python -m build`)

https://build.pypa.io/en/stable/

ã“ã‚Œã¯ `pip` ã‚„ `uv` ã®ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†æ©Ÿèƒ½ã¨ã¯åˆ‡ã‚Šé›¢ã•ã‚ŒãŸã€å˜ç´”ã«Build Frontendã¨ã—ã¦å‹•ä½œã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚`pyproject.toml`ã®`build-backend` ã‚’èµ·å‹•ã—ã¾ã™ã€‚

### setuptools (`setup.py`)

ä¸Šã®ä»•çµ„ã¿ãŒå‡ºæ¥ä¸ŠãŒã‚‹å‰ã‹ã‚‰ä½¿ã‚ã‚Œã¦ã„ã‚‹ä¼çµ±çš„ãªãƒ„ãƒ¼ãƒ«ã§ã™ã€‚[`61.0.0` ã‹ã‚‰ä¸Šã®ä»•çµ„ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—](https://setuptools.pypa.io/en/latest/userguide/pyproject_config.html)ã€Build Backendã¨ã—ã¦ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚æ¬¡ã®ã‚ˆã†ã« `pyproject.toml` ã«è¨˜è¿°ã—ã¾ã™:

```toml:pyproject.toml
[build-system]
requires = ["setuptools", "setuptools-scm"]
build-backend = "setuptools.build_meta"
```

æ—§æ¥ã® `setup.py` ã«ã‚ˆã‚‹ä»•çµ„ã¿ã¯å»ƒæ­¢ã•ã‚Œã‚‹äºˆå®šã§ã™ãŒã€ç¾çŠ¶ã® `pip` ã¯ `setup.py` ã‚’è¦‹ã¤ã‘ãŸã‚‰Build Backendã¨ã—ã¦ `setuptools` ãŒæŒ‡å®šã•ã‚ŒãŸã‚ˆã†ã«å‹•ä½œã—ã¾ã™ã€‚

### scikit-build / scikit-build-core

[scikit-build](https://scikit-build.readthedocs.io/en/latest/)ã¯cmakeã‚’ä½¿ã£ãŸãƒ“ãƒ«ãƒ‰ã‚’setuptoolsã¨é€£æºã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã—ãŸãŒã€å‰ç¯€ã®é€šã‚Šsetuptoolsã®ãƒ¬ã‚¬ã‚·ãƒ¼æ©Ÿæ§‹ã¯å»ƒæ­¢ã•ã‚Œã‚‹äºˆå®šãªã®ã§ã€æ–°ãŸã«Build Backendã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹[scikit-build-core](https://scikit-build-core.readthedocs.io/en/latest/)ãŒé–‹ç™ºã•ã‚Œã¦ã„ã¾ã™ã€‚

```toml:pyproject.toml
[build-system]
requires = ["scikit-build-core"]
build-backend = "scikit_build_core.build"

[project]
name = "scikit_build_simplest"
version = "0.0.1"
```
---
title: リンクと共有ライブラリ
---

ここではRustと他の言語との相互運用についての準備として、Linuxにおけるオブジェクトファイルのリンクと、共有ライブラリのロードに関する話をします。これはOS（カーネルに加えて開発用のツールチェインを含めた意味）に強く依存する部分ですが、WindowsやmacOSでもいくつかの環境変数やコマンドを読み替えるだけで概ね同じになる範囲を扱います。

実行可能なファイルとリンク
-------------------------
Rustで実行可能なターゲット (`src/bin/main.rs`のようなファイル) を含むプロジェクトをビルドすると実行ファイルが出来上がりますが、どうしてOSはこれを実行できるのでしょうか？OSはそれぞれが実行可能なファイルのフォーマットを規定していて、それにそってファイルを作成することで実行可能なファイルを作成できます。Linuxでは[ELF (Executable and Linkable Format)](https://ja.wikipedia.org/wiki/Executable_and_Linkable_Format)というフォーマットが使われています。

その名の通りELFにはリンク可能なファイルを格納する事が出来ます。例えば数百ファイルのソースコードからなるプロジェクトがあるとしましょう。これらのソースコードをコンパイルして一つの実行可能なファイルを一気に作るのは大変なので、それぞれのソースコードファイルを個別にコンパイルして、最後にそれらを結合出来ると便利です。この結合処理の事をリンクと呼び、個別にコンパイルされたデータを保存したファイルをオブジェクトファイルと呼びます。オブジェクトファイルもELF形式で保存することができ、ファイル名に`.o`という拡張子を使うことが多いです。別のソースコードで実装された関数を呼び出すような操作はオブジェクトファイルの段階では「どこかの〇〇という名前の関数を呼び出す」という形で記録されているだけで、実際に呼び出す関数がどこにあるかは分かっていません。リンクの処理はこれらの呼び出しを実際の関数のアドレスに置き換える処理を行います。

ELFで表現できるもう一つの重要ものとして共有ライブラリがあります。これは実行時にロードして呼び出すことが出来る命令の塊です。複数の実行可能なファイルで共通の処理を共有ライブラリとして使うことでファイルを小さくできるほか、プログラムを再コンパイルすることなく機能を追加するプラグイン機能の実装、あるいはプロセスを停止させずに実装を挿げ替えたりするのに使う事が出来ます。またOSの機能の幾つかは共有ライブラリとして提供されます。

共通基盤としてのC言語
--------------------
以下ではリンクについての基本的な事項をC言語で説明していきます。何故ならリンクのためのツールはまずC言語で動くように設計されており、なのでC言語の基本的な概念がそのままリンクの基本的な概念として現れるからです。Rustや他の多くの言語 (例えばC++) はC言語におけるリンクの仕組みの上に追加の情報を付加することで、ツールをそのまま利用しつつより高度なリンクを実現しています。

この意味でC言語はある種の共通基盤として使えます。複数の異なる言語で実装されたソースコードのそれぞれをあたかもC言語で実装されたかのようにオブジェクトファイルにコンパイルすることで、C言語で実装されたオブジェクトファイルと同じようにリンクすることができます。また共有ライブラリの呼び出しもC言語の関数呼び出しと同じように行うため、別の言語で実装されたソースコードをC言語の時と同じように共有ライブラリにコンパイルすることで、C言語で実装された共有ライブラリと同じように呼び出すことが出来ます。この際のインターフェースの事をABIと呼びます。

:::message
これはよくC ABIと呼ばれますが、あくまで定めているのはOS (および付属するリンカ・ローダ) であって、C言語自体が定めているわけではないことに注意してください。
:::

C言語の言語機能は例えばRustからみると非常に貧弱で構造体と関数くらいしかなく、Rustのような複雑な言語機能を持つ言語はOSが定めるABIに加えて、その上に独自のABIを定めることでより多くの情報を実行時に利用できるようにしています。残念ながらまだRustのABIは安定化されておらず、コンパイラのバージョンに依存します。別言語との相互運用を行う際には双方でこの追加のABIについての合意が無いので、これらの情報を予め捨てておく(`extern`構文を使う)、あるいは別途変換機構を用意する必要があることに注意してください。例えばRustからC++で実装された機能を呼び出す場合、C言語としてのABIを経由する必要があるのでC++の機能の多く (例えば仮想関数の呼び出し) を使うことは出来ません。

